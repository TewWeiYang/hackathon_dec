<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Collectible Puzzle System - Spring Town Map</title>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(180deg, #eaf8df, #f7fff3);
  text-align: center;
  color: #333;
}

/* UI Header (page hero text) */
.hero { padding: 24px 16px 10px; }
.hero h1 { margin: 0; font-size: 28px; }
.hero p { margin-top: 6px; font-size: 14px; color: #666; }

/* Progress info */
.progress-card {
  display: flex;
  justify-content: space-around;
  background: #fff;
  border-radius: 14px;
  padding: 12px;
  margin: 10px auto 16px;
  max-width: 360px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}
.progress-card div { font-size: 13px; }
.progress-card strong { display: block; margin-bottom: 4px; }

/* Buttons */
button {
  background: linear-gradient(135deg, #ff9a00, #ff6a00);
  color: #fff;
  border: none;
  border-radius: 30px;
  padding: 14px;
  font-size: 15px;
  font-weight: bold;
  width: 90%;
  max-width: 320px;
  margin: 6px 0;
  box-shadow: 0 10px 20px rgba(255,106,0,.35);
  cursor: pointer;
}
button.secondary {
  background: linear-gradient(135deg, #4caf50, #2e7d32);
}

/* Puzzle small UI */
.puzzles {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin: 18px auto;
}
.puzzle {
  width: 80px;
  height: 80px;
  background: #ddd;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0,0,0,.2);
}
.puzzle.done {
  background-image: url("puzzle.jpg");
  background-size: 200% 200%;
  animation: unlock .5s ease forwards;
}
@keyframes unlock {
  from { opacity: 0; transform: scale(.7); }
  to { opacity: 1; transform: scale(1); }
}
.p1 { background-position: 0% 0%; }
.p2 { background-position: 100% 0%; }
.p3 { background-position: 0% 100%; }
.p4 { background-position: 100% 100%; }

/* Track container */
.track-wrapper {
  width: 100%;
  max-width: 100%;
  margin: 0 auto;
}
.track-wrapper svg {
  width: 100%;
  display: block;
}

/* Reward overlay */
#rewardOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 900;
}
.reward-card {
  background: #fff;
  border-radius: 18px;
  padding: 20px 18px 16px;
  width: 80%;
  max-width: 340px;
  box-shadow: 0 8px 24px rgba(0,0,0,.25);
  text-align: center;
}
.reward-icon {
  font-size: 40px;
  margin-bottom: 8px;
}
.reward-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 4px;
}
.reward-desc {
  font-size: 14px;
  color: #666;
  margin-bottom: 16px;
}
.reward-step {
  font-size: 12px;
  color: #999;
  margin-bottom: 10px;
}
.reward-close-btn {
  background: linear-gradient(135deg, #ff9a00, #ff6a00);
  color: #fff;
  border: none;
  border-radius: 999px;
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
}

/* ===== NAV BAR ===== */
header {
  background: #2e6b41;
  color: white;
  padding: 16px 40px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.left-title { flex: 1; text-align: left; }
.left-title h1 { margin: 0; font-size: 24px; }

.left-title h1 a,
.left-title h1 a:visited {
  color: #ffffff !important;
  text-decoration: none;
}
.left-title h1 a:hover {
  color: #ffffff !important;
  text-decoration: underline;
}

.logo-center {
  flex: 1;
  display: flex;
  justify-content: center;
}
.nav-logo {
  height: 65px;
  width: auto;
  cursor: pointer;
}

.right-nav { 
  flex: 1; 
  text-align: right; 
}
.right-nav a {
  color: white;
  margin-left: 20px;
  text-decoration: none;
  font-weight: bold;
  font-size: 18px;
}
.right-nav a:hover { 
  text-decoration: underline; 
}

/* ===== Logo Popup Modal ===== */
#logoModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
  justify-content: center;
  align-items: center;
  z-index: 999;
}
#logoModal img {
  max-width: 80%;
  max-height: 80%;
  border-radius: 16px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}
#closeLogo {
  position: absolute;
  top: 30px;
  right: 40px;
  font-size: 36px;
  font-weight: bold;
  color: white;
  cursor: pointer;
}
</style>
</head>

<body>

<!-- NAVBAR -->
<header>
  <div class="left-title">
    <h1><a href="home.html">EcoSave</a></h1>
  </div>

  <div class="logo-center">
    <img src="logo.png" alt="One Step Save World Logo" class="nav-logo" id="logoBtn">
  </div>

  <nav class="right-nav">
    <a href="home_afterlogin.html">Home</a>
    <a href="works.html">How It Works</a>
    <a href="sendemail+otp.html">Profile</a>
  </nav>
</header>

<!-- Title section -->
<div class="hero">
  <h1>Collectible Puzzle System</h1>
  <p>Complete tasks, earn points, collect puzzles</p>
</div>

<!-- UI Info -->
<div class="progress-card">
  <div><strong>Points</strong><span id="points">0</span></div>
  <div><strong>Steps</strong><span id="step">0</span> / 100</div>
  <div><strong>Puzzle</strong><span id="puzzleCount">0</span> / 4</div>
</div>

<!-- Buttons -->
<button class="secondary" onclick="completeTask()">üéØ Complete Task (+20)</button>
<button onclick="exchangeSteps()">üöó Exchange Points ‚Üí Move</button>

<!-- MAP START -->
<div class="track-wrapper">
<svg id="gameSvg" viewBox="0 0 1920 1080" xmlns="http://www.w3.org/2000/svg">

  <defs>
    <linearGradient id="bgGrad" x1="0" x2="0" y1="0" y2="1">
      <stop offset="0%" stop-color="#d7f6b8"/>
      <stop offset="100%" stop-color="#b2e69f"/>
    </linearGradient>

    <linearGradient id="roadGrad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#f2c14e"/>
      <stop offset="100%" stop-color="#ddb142"/>
    </linearGradient>

    <linearGradient id="shadowGrad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#b28a36" stop-opacity="0.2"/>
      <stop offset="100%" stop-color="#000" stop-opacity="0"/>
    </linearGradient>

    <filter id="smokeBlur">
      <feGaussianBlur stdDeviation="4" />
    </filter>
  </defs>

  <rect width="1920" height="1080" fill="url(#bgGrad)" />

  <ellipse cx="500" cy="900" rx="900" ry="300" fill="#b6e29b" />
  <ellipse cx="1400" cy="950" rx="1100" ry="350" fill="#aee092" />
  
  <path d="M300,1080 C500,700 600,700 900,1080 Z"
        fill="#96d6ff" opacity="0.7"/>

  <path d="
        M 360 180
        Q 960 120 1560 180
        Q 1680 240 1680 540
        Q 1680 840 1560 900
        Q 960 960 360 900
        Q 240 840 240 540
        Q 240 240 360 180
        Z
        "
        fill="url(#shadowGrad)"
        transform="translate(8,8)" />

  <path id="road"
        d="
        M 360 180
        Q 960 120 1560 180
        Q 1680 240 1680 540
        Q 1680 840 1560 900
        Q 960 960 360 900
        Q 240 840 240 540
        Q 240 240 360 180
        Z
        "
        fill="url(#roadGrad)"
        stroke="black"
        stroke-width="20"
        stroke-linecap="round"
        stroke-linejoin="round"/>

  <g fill="#6dbc42">
    <circle cx="400" cy="300" r="30"/>
    <circle cx="440" cy="320" r="25"/>
    <circle cx="1500" cy="250" r="30"/>
    <circle cx="1450" cy="280" r="30"/>
    <circle cx="1200" cy="800" r="35"/>
    <circle cx="1180" cy="840" r="30"/>
    <circle cx="800" cy="900" r="25"/>
    <circle cx="820" cy="930" r="25"/>
  </g>

  <g fill="#fff" stroke="#e44d4d" stroke-width="4">
    <rect x="300" y="280" width="100" height="80"/>
    <polygon points="300,280 350,220 400,280"/>
    
    <rect x="1500" y="700" width="120" height="90"/>
    <polygon points="1500,700 1560,640 1620,700"/>
  </g>

  <circle cx="360" cy="180" r="20" fill="#ff6a00"/>
  <text x="360" y="185" font-size="20" text-anchor="middle" fill="red">START</text>

  <g id="giftMarkers"></g>
  <g id="smokeLayer"></g>

  <g id="car" transform="translate(360 180)">
    <rect x="-32" y="-14" width="64" height="26" rx="8" fill="#ff4a4a"/>
    <rect x="-18" y="-26" width="36" height="16" rx="5" fill="#ffd7d7"/>
    <rect x="-12" y="-24" width="14" height="12" rx="3" fill="#ffffff" opacity="0.9"/>
    <rect x="2" y="-24" width="14" height="12" rx="3" fill="#ffffff" opacity="0.9"/>
    <circle cx="-18" cy="14" r="8" fill="#333"/>
    <circle cx="18" cy="14" r="8" fill="#333"/>
    <circle cx="-18" cy="14" r="4" fill="#999"/>
    <circle cx="18" cy="14" r="4" fill="#999"/>
  </g>

</svg>
</div>
<!-- MAP END -->

<!-- Puzzle UI -->
<div class="puzzles">
  <div class="puzzle p1" id="pz1"></div>
  <div class="puzzle p2" id="pz2"></div>
  <div class="puzzle p3" id="pz3"></div>
  <div class="puzzle p4" id="pz4"></div>
</div>

<!-- Reward Overlay -->
<div id="rewardOverlay">
  <div class="reward-card">
    <div class="reward-icon" id="rewardIcon">üéÅ</div>
    <div class="reward-title" id="rewardTitle">Reward unlocked!</div>
    <div class="reward-step" id="rewardStepText">Step 25</div>
    <div class="reward-desc" id="rewardDesc">
      You can claim a surprise gift in your reward center.
    </div>
    <button class="reward-close-btn" onclick="closeReward()">OK</button>
  </div>
</div>

<!-- Logo Popup Modal -->
<div id="logoModal">
  <span id="closeLogo">‚úï</span>
  <img src="logo.png" alt="Logo Large View">
</div>

<!-- JS -->
<script>
/* ---------- STATE & CONSTANTS ---------- */
// ‰ªé localStorage ËØªÂèñÁßØÂàÜ
let points = parseInt(localStorage.getItem("ecoPoints") || "0", 10);
let currentStep = 0;
let puzzleCount = 0;
const costPerStep = 10;

// Á§ºÁâ©ÁÇπ
const giftSteps = [25, 75];
const giftRewards = {
  25: {
    icon: "üéÅ",
    title: "First Reward",
    desc: "You reached Step 25! Bonus +100 Eco Points have been added."
  },
  75: {
    icon: "üèÜ",
    title: "Second Reward",
    desc: "You reached Step 75! Bonus +200 Eco Points have been added."
  }
};

/* ---------- DOM ELEMENTS ---------- */
const pointsEl = document.getElementById("points");
const stepEl = document.getElementById("step");
const puzzleCountEl = document.getElementById("puzzleCount");

const svg = document.getElementById("gameSvg");
const path = document.getElementById("road");
const car = document.getElementById("car");
const smokeLayer = document.getElementById("smokeLayer");
const giftMarkersLayer = document.getElementById("giftMarkers");
const pathLength = path.getTotalLength();

const rewardOverlay = document.getElementById("rewardOverlay");
const rewardIconEl = document.getElementById("rewardIcon");
const rewardTitleEl = document.getElementById("rewardTitle");
const rewardDescEl = document.getElementById("rewardDesc");
const rewardStepTextEl = document.getElementById("rewardStepText");

const particles = [];
const PARTICLE_LIFETIME = 800; // ÊØ´Áßí

/* ---------- HELPERS ---------- */
function savePoints() {
  localStorage.setItem("ecoPoints", String(points));
}

function updateUI() {
  pointsEl.textContent = points;
  stepEl.textContent = currentStep;
  puzzleCountEl.textContent = puzzleCount;
}

/* ÂàùÂßã UI */
updateUI();

/* ---------- TASK / STEP LOGIC ---------- */
function completeTask() {
  points += 20;
  savePoints();
  updateUI();
}

function exchangeSteps() {
  if (points < costPerStep) {
    alert("Not enough points!");
    return;
  }
  points -= costPerStep;
  savePoints();

  currentStep++;

  if (giftSteps.includes(currentStep)) {
    showReward(currentStep);
  }

  if (currentStep === 100) {
    puzzleCount++;
    if (puzzleCount <= 4) {
      document.getElementById("pz" + puzzleCount).classList.add("done");
    }
    currentStep = 0;
    updateUI();
    updateCarPosition(true);

    // Ë∑ëÂÆå‰∏ÄÂúà ‚Üí ÂéªÂπ∏ËøêËΩ¨Áõò
    window.location.href = "lucky_draw.html";
    return;
  }

  updateUI();
  updateCarPosition(true);
}

/* ---------- CAR & SMOKE ---------- */
function updateCarPosition(spawnSmokeFlag) {
  const progress = currentStep / 100;
  const distance = pathLength * progress;
  const pt = path.getPointAtLength(distance);

  car.setAttribute("transform", `translate(${pt.x} ${pt.y})`);

  if (spawnSmokeFlag) {
    const prevDist = Math.max(0, distance - 20);
    const prevPt = path.getPointAtLength(prevDist);

    const dx = pt.x - prevPt.x;
    const dy = pt.y - prevPt.y;
    const len = Math.sqrt(dx*dx + dy*dy) || 1;
    const nx = dx / len;
    const ny = dy / len;

    const smokeX = pt.x - nx * 40;
    const smokeY = pt.y - ny * 40;

    spawnSmoke(smokeX, smokeY);
  }
}

function spawnSmoke(x, y) {
  const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  const jitterX = (Math.random() - 0.5) * 20;
  const jitterY = (Math.random() - 0.5) * 10;

  circle.setAttribute("cx", x + jitterX);
  circle.setAttribute("cy", y + jitterY);
  circle.setAttribute("r", 6);
  circle.setAttribute("fill", "#ffffff");
  circle.setAttribute("opacity", "0.7");
  circle.setAttribute("filter", "url(#smokeBlur)");

  smokeLayer.appendChild(circle);

  particles.push({
    el: circle,
    start: performance.now()
  });
}

function updateParticles(timestamp) {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    const age = timestamp - p.start;
    if (age >= PARTICLE_LIFETIME) {
      if (p.el.parentNode) p.el.parentNode.removeChild(p.el);
      particles.splice(i, 1);
      continue;
    }

    const t = age / PARTICLE_LIFETIME;
    const newR = 6 + t * 14;
    const newOpacity = 0.7 * (1 - t);

    p.el.setAttribute("r", newR);
    p.el.setAttribute("opacity", newOpacity);

    const cy = parseFloat(p.el.getAttribute("cy"));
    p.el.setAttribute("cy", cy - 0.4);
  }

  requestAnimationFrame(updateParticles);
}

/* ---------- REWARD POPUP ---------- */
function showReward(step) {
  const reward = giftRewards[step] || {
    icon: "üéÅ",
    title: "Special Reward",
    desc: "You just unlocked a special reward!"
  };

  if (step === 25) {
    points += 100;
  } else if (step === 75) {
    points += 200;
  }
  savePoints();
  updateUI();

  rewardIconEl.textContent = reward.icon;
  rewardTitleEl.textContent = reward.title;
  rewardDescEl.textContent = reward.desc;
  rewardStepTextEl.textContent = `Step ${step}`;

  rewardOverlay.style.display = "flex";
}

function closeReward() {
  rewardOverlay.style.display = "none";
}

/* ---------- GIFT MARKERS ON MAP ---------- */
function placeGiftMarkers() {
  giftSteps.forEach(step => {
    const progress = step / 100;
    const distance = pathLength * progress;
    const pt = path.getPointAtLength(distance);

    const marker = document.createElementNS("http://www.w3.org/2000/svg", "text");
    marker.setAttribute("x", pt.x);
    marker.setAttribute("y", pt.y - 16);
    marker.setAttribute("text-anchor", "middle");
    marker.setAttribute("font-size", "32");
    marker.textContent = "üéÅ";

    giftMarkersLayer.appendChild(marker);
  });
}

/* ÂàùÂßã‰ΩçÁΩÆ / Á≤íÂ≠êÂä®Áîª / Á§ºÁâ©Ê†áËÆ∞ */
updateCarPosition(false);
placeGiftMarkers();
requestAnimationFrame(updateParticles);

/* ---------- Logo popup control ---------- */
const logoBtn   = document.getElementById("logoBtn");
const logoModal = document.getElementById("logoModal");
const closeLogo = document.getElementById("closeLogo");

logoBtn.onclick = () => {
  logoModal.style.display = "flex";
};

closeLogo.onclick = () => {
  logoModal.style.display = "none";
};

logoModal.onclick = (e) => {
  if (e.target === logoModal) {
    logoModal.style.display = "none";
  }
};
</script>

</body>
</html>
