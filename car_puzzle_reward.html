<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Collectible Puzzle System - Spring Town Map</title>
 
<style>
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(180deg, #eaf8df, #f7fff3);
    text-align: center;
    color: #333;
  }
 
  /* NAVBAR */
  .eco-bar {
    position: sticky;
    top: 0;
    z-index: 50;
    backdrop-filter: blur(14px);
    background: linear-gradient(120deg, rgba(46,107,65,0.98), rgba(34,73,47,0.98));
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 32px;
    box-shadow: 0 12px 30px rgba(15,23,42,0.32);
  }
 
  .eco-left h2 {
    margin: 0;
    font-size: 24px;
    font-weight: 800;
    letter-spacing: .5px;
  }
 
  .eco-center {
    flex: 1;
    display: flex;
    justify-content: center;
  }
 
  .eco-logo {
    height: 60px;
    width: auto;
    cursor: pointer;
    border-radius: 999px;
    background: #ffffff;
    padding: 4px 14px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.25);
    transition: transform .22s ease, box-shadow .22s ease;
  }
 
  .eco-logo:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 14px 26px rgba(0,0,0,0.35);
  }
 
  .eco-right a {
    margin-left: 24px;
    color: #e5f7ec;
    text-decoration: none;
    font-weight: 600;
    font-size: 15px;
    position: relative;
    padding-bottom: 2px;
    transition: color .18s ease;
  }
 
  .eco-right a::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: 0;
    width: 0;
    height: 2px;
    background: #fff;
    transition: width .18s ease;
  }
 
  .eco-right a:hover { color: #ffffff; }
  .eco-right a:hover::after { width: 100%; }
 
  /* LOGO MODAL (ONLY ONE, NO DUPLICATE ID) */
  #logoModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.65);
    backdrop-filter: blur(6px);
    justify-content: center;
    align-items: center;
    z-index: 999;
  }
  #logoModal img {
    max-width: 80%;
    max-height: 80%;
    border-radius: 20px;
    box-shadow: 0 8px 26px rgba(0,0,0,0.45);
    animation: zoomIn 0.25s ease;
    background: #ffffff;
  }
  #closeLogo {
    position: absolute;
    top: 36px;
    right: 46px;
    font-size: 40px;
    font-weight: 700;
    color: white;
    cursor: pointer;
    user-select: none;
  }
  @keyframes zoomIn {
    from { opacity: 0; transform: scale(0.8); }
    to   { opacity: 1; transform: scale(1); }
  }
 
  /* UI Header */
  .hero { padding: 24px 16px 10px; }
  .hero h1 { margin: 0; font-size: 28px; }
  .hero p { margin-top: 6px; font-size: 14px; color: #666; }
 
  /* Progress info */
  .progress-card {
    display: flex;
    justify-content: space-around;
    background: #fff;
    border-radius: 14px;
    padding: 12px;
    margin: 10px auto 16px;
    max-width: 360px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  }
  .progress-card div { font-size: 13px; }
  .progress-card strong { display: block; margin-bottom: 4px; }
 
  /* Buttons */
  button {
    background: linear-gradient(135deg, #ff9a00, #ff6a00);
    color: #fff;
    border: none;
    border-radius: 30px;
    padding: 14px;
    font-size: 15px;
    font-weight: bold;
    width: 90%;
    max-width: 320px;
    margin: 6px 0;
    box-shadow: 0 10px 20px rgba(255,106,0,.35);
    cursor: pointer;
  }
  button.secondary {
    background: linear-gradient(135deg, #4caf50, #2e7d32);
  }
 
  /* Puzzle UI */
  .puzzles {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 18px auto;
  }
  .puzzle {
    width: 80px;
    height: 80px;
    background: #ddd;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,.2);
  }
  .puzzle.done {
    background-image: url("puzzle.jpg");
    background-size: 200% 200%;
    animation: unlock .5s ease forwards;
  }
  @keyframes unlock {
    from { opacity: 0; transform: scale(.7); }
    to { opacity: 1; transform: scale(1); }
  }
  .p1 { background-position: 0% 0%; }
  .p2 { background-position: 100% 0%; }
  .p3 { background-position: 0% 100%; }
  .p4 { background-position: 100% 100%; }
 
  /* Track wrapper */
  .track-wrapper {
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
  }
  .track-wrapper svg { width: 100%; display: block; }
 
  /* Reward overlay */
  #rewardOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 900;
  }
  .reward-card {
    background: #fff;
    border-radius: 18px;
    padding: 20px 18px 16px;
    width: 80%;
    max-width: 340px;
    box-shadow: 0 8px 24px rgba(0,0,0,.25);
    text-align: center;
  }
  .reward-icon { font-size: 40px; margin-bottom: 8px; }
  .reward-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
  .reward-desc { font-size: 14px; color: #666; margin-bottom: 16px; }
  .reward-step { font-size: 12px; color: #999; margin-bottom: 10px; }
  .reward-close-btn {
    background: linear-gradient(135deg, #ff9a00, #ff6a00);
    color: #fff;
    border: none;
    border-radius: 999px;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
  }
 
  @media (max-width: 768px) {
    .eco-bar { padding: 8px 16px; }
    .eco-left h2 { font-size: 20px; }
    .eco-right a { margin-left: 14px; font-size: 14px; }
  }
</style>
</head>
 
<body>
 
<!-- TOP NAVBAR -->
<nav class="eco-bar">
  <div class="eco-left"><h2>EcoSave</h2></div>
 
  <div class="eco-center">
    <img src="logo.png" class="eco-logo" id="logoBtn" alt="EcoSave Logo">
  </div>
 
  <div class="eco-right">
    <a href="home.html">Home</a>
    <a href="works.html">How It Works</a>
    <a href="sendemail+otp.html">Login</a>
  </div>
</nav>
 
<!-- LOGO POPUP MODAL (ONLY ONCE) -->
<div id="logoModal">
  <span id="closeLogo">‚úï</span>
  <img src="logo.png" alt="EcoSave Logo Large">
</div>
 
<!-- Title -->
<div class="hero">
  <h1>Collectible Puzzle System</h1>
  <p>Complete tasks, earn points, collect puzzles</p>
</div>
 
<!-- Progress -->
<div class="progress-card">
  <div><strong>Points</strong><span id="points">0</span></div>
  <div><strong>Steps</strong><span id="step">0</span> / 100</div>
  <div><strong>Puzzle</strong><span id="puzzleCount">0</span> / 4</div>
</div>
 
<!-- Buttons -->
<button class="secondary" id="btnCompleteTask">üéØ Complete Task (+20)</button>
<button id="btnExchange">üöó Exchange Points ‚Üí Move</button>
 
<!-- MAP -->
<div class="track-wrapper">
<svg id="gameSvg" viewBox="0 0 1920 1080" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="bgGrad" x1="0" x2="0" y1="0" y2="1">
      <stop offset="0%" stop-color="#d7f6b8"/>
      <stop offset="100%" stop-color="#b2e69f"/>
    </linearGradient>
 
    <linearGradient id="roadGrad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#f2c14e"/>
      <stop offset="100%" stop-color="#ddb142"/>
    </linearGradient>
 
    <linearGradient id="shadowGrad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#b28a36" stop-opacity="0.2"/>
      <stop offset="100%" stop-color="#000" stop-opacity="0"/>
    </linearGradient>
 
    <filter id="smokeBlur"><feGaussianBlur stdDeviation="4" /></filter>
  </defs>
 
  <rect width="1920" height="1080" fill="url(#bgGrad)" />
  <ellipse cx="500" cy="900" rx="900" ry="300" fill="#b6e29b" />
  <ellipse cx="1400" cy="950" rx="1100" ry="350" fill="#aee092" />
  <path d="M300,1080 C500,700 600,700 900,1080 Z" fill="#96d6ff" opacity="0.7"/>
 
  <path d="
        M 360 180
        Q 960 120 1560 180
        Q 1680 240 1680 540
        Q 1680 840 1560 900
        Q 960 960 360 900
        Q 240 840 240 540
        Q 240 240 360 180
        Z"
        fill="url(#shadowGrad)"
        transform="translate(8,8)" />
 
  <path id="road"
        d="
        M 360 180
        Q 960 120 1560 180
        Q 1680 240 1680 540
        Q 1680 840 1560 900
        Q 960 960 360 900
        Q 240 840 240 540
        Q 240 240 360 180
        Z"
        fill="url(#roadGrad)"
        stroke="black"
        stroke-width="20"
        stroke-linecap="round"
        stroke-linejoin="round"/>
 
  <g fill="#6dbc42">
    <circle cx="400" cy="300" r="30"/>
    <circle cx="440" cy="320" r="25"/>
    <circle cx="1500" cy="250" r="30"/>
    <circle cx="1450" cy="280" r="30"/>
    <circle cx="1200" cy="800" r="35"/>
    <circle cx="1180" cy="840" r="30"/>
    <circle cx="800" cy="900" r="25"/>
    <circle cx="820" cy="930" r="25"/>
  </g>
 
  <g fill="#fff" stroke="#e44d4d" stroke-width="4">
    <rect x="300" y="280" width="100" height="80"/>
    <polygon points="300,280 350,220 400,280"/>
    <rect x="1500" y="700" width="120" height="90"/>
    <polygon points="1500,700 1560,640 1620,700"/>
  </g>
 
  <circle cx="360" cy="180" r="20" fill="#ff6a00"/>
  <text x="360" y="185" font-size="20" text-anchor="middle" fill="red">START</text>
 
  <g id="giftMarkers"></g>
  <g id="smokeLayer"></g>
 
  <g id="car" transform="translate(360 180)">
    <rect x="-32" y="-14" width="64" height="26" rx="8" fill="#ff4a4a"/>
    <rect x="-18" y="-26" width="36" height="16" rx="5" fill="#ffd7d7"/>
    <rect x="-12" y="-24" width="14" height="12" rx="3" fill="#ffffff" opacity="0.9"/>
    <rect x="2" y="-24" width="14" height="12" rx="3" fill="#ffffff" opacity="0.9"/>
    <circle cx="-18" cy="14" r="8" fill="#333"/>
    <circle cx="18" cy="14" r="8" fill="#333"/>
    <circle cx="-18" cy="14" r="4" fill="#999"/>
    <circle cx="18" cy="14" r="4" fill="#999"/>
  </g>
</svg>
</div>
 
<!-- Puzzle UI -->
<div class="puzzles">
  <div class="puzzle p1" id="pz1"></div>
  <div class="puzzle p2" id="pz2"></div>
  <div class="puzzle p3" id="pz3"></div>
  <div class="puzzle p4" id="pz4"></div>
</div>
 
<!-- Reward Overlay -->
<div id="rewardOverlay">
  <div class="reward-card">
    <div class="reward-icon" id="rewardIcon">üéÅ</div>
    <div class="reward-title" id="rewardTitle">Reward unlocked!</div>
    <div class="reward-step" id="rewardStepText">Step 25</div>
    <div class="reward-desc" id="rewardDesc">
      You can claim a surprise gift in your reward center.
    </div>
    <button class="reward-close-btn" id="btnRewardOk">OK</button>
  </div>
</div>
 
<script>
/* =========================================================
   Car Puzzle Reward Page - Clean Version
   - No duplicate IDs
   - No duplicate const declarations
   - Points update will always work
========================================================= */
 
/* ---------- GLOBAL POINTS ---------- */
function getPoints() {
  const v = parseInt(localStorage.getItem("ecoPoints") || "0", 10);
  return Number.isFinite(v) ? v : 0;
}
function setPoints(v) {
  localStorage.setItem("ecoPoints", String(Math.max(0, Math.floor(Number(v) || 0))));
}
function addPoints(v) {
  const cur = getPoints();
  setPoints(cur + Math.floor(Number(v) || 0));
  return getPoints();
}
 
/* ---------- STATE ---------- */
let points = getPoints();
let currentStep = 0;
let puzzleCount = 0;
const costPerStep = 10;
 
const giftSteps = [25, 75];
const giftRewards = {
  25: { icon: "üéÅ", title: "First Reward", desc: "You reached Step 25! Bonus +100 Eco Points have been added." },
  75: { icon: "üèÜ", title: "Second Reward", desc: "You reached Step 75! Bonus +200 Eco Points have been added." }
};
 
/* ---------- DOM ---------- */
const pointsEl = document.getElementById("points");
const stepEl = document.getElementById("step");
const puzzleCountEl = document.getElementById("puzzleCount");
 
const path = document.getElementById("road");
const car = document.getElementById("car");
const smokeLayer = document.getElementById("smokeLayer");
const giftMarkersLayer = document.getElementById("giftMarkers");
const pathLength = path.getTotalLength();
 
const rewardOverlay = document.getElementById("rewardOverlay");
const rewardIconEl = document.getElementById("rewardIcon");
const rewardTitleEl = document.getElementById("rewardTitle");
const rewardDescEl = document.getElementById("rewardDesc");
const rewardStepTextEl = document.getElementById("rewardStepText");
 
const btnCompleteTask = document.getElementById("btnCompleteTask");
const btnExchange = document.getElementById("btnExchange");
const btnRewardOk = document.getElementById("btnRewardOk");
 
/* ---------- UI ---------- */
function updateUI() {
  pointsEl.textContent = points;
  stepEl.textContent = currentStep;
  puzzleCountEl.textContent = puzzleCount;
}
 
/* ---------- CAR & SMOKE ---------- */
const particles = [];
const PARTICLE_LIFETIME = 800;
 
function spawnSmoke(x, y) {
  const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  circle.setAttribute("cx", x + (Math.random() - 0.5) * 20);
  circle.setAttribute("cy", y + (Math.random() - 0.5) * 10);
  circle.setAttribute("r", 6);
  circle.setAttribute("fill", "#ffffff");
  circle.setAttribute("opacity", "0.7");
  circle.setAttribute("filter", "url(#smokeBlur)");
  smokeLayer.appendChild(circle);
 
  particles.push({ el: circle, start: performance.now() });
}
 
function updateParticles(timestamp) {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    const age = timestamp - p.start;
 
    if (age >= PARTICLE_LIFETIME) {
      p.el.remove();
      particles.splice(i, 1);
      continue;
    }
 
    const t = age / PARTICLE_LIFETIME;
    p.el.setAttribute("r", 6 + t * 14);
    p.el.setAttribute("opacity", 0.7 * (1 - t));
    p.el.setAttribute("cy", String(parseFloat(p.el.getAttribute("cy")) - 0.4));
  }
  requestAnimationFrame(updateParticles);
}
 
function updateCarPosition(spawnSmokeFlag) {
  const progress = currentStep / 100;
  const distance = pathLength * progress;
  const pt = path.getPointAtLength(distance);
  car.setAttribute("transform", `translate(${pt.x} ${pt.y})`);
 
  if (spawnSmokeFlag) {
    const prevDist = Math.max(0, distance - 20);
    const prevPt = path.getPointAtLength(prevDist);
    const dx = pt.x - prevPt.x;
    const dy = pt.y - prevPt.y;
    const len = Math.sqrt(dx*dx + dy*dy) || 1;
    const nx = dx / len;
    const ny = dy / len;
    spawnSmoke(pt.x - nx * 40, pt.y - ny * 40);
  }
}
 
/* ---------- REWARD POPUP ---------- */
function showReward(step) {
  const reward = giftRewards[step] || { icon: "üéÅ", title: "Special Reward", desc: "You just unlocked a special reward!" };
 
  if (step === 25) points = addPoints(100);
  if (step === 75) points = addPoints(200);
 
  rewardIconEl.textContent = reward.icon;
  rewardTitleEl.textContent = reward.title;
  rewardDescEl.textContent = reward.desc;
  rewardStepTextEl.textContent = `Step ${step}`;
 
  updateUI();
  rewardOverlay.style.display = "flex";
}
 
function closeReward() {
  rewardOverlay.style.display = "none";
}
 
/* ---------- MAP MARKERS ---------- */
function placeGiftMarkers() {
  giftSteps.forEach(step => {
    const distance = pathLength * (step / 100);
    const pt = path.getPointAtLength(distance);
 
    const marker = document.createElementNS("http://www.w3.org/2000/svg", "text");
    marker.setAttribute("x", pt.x);
    marker.setAttribute("y", pt.y - 16);
    marker.setAttribute("text-anchor", "middle");
    marker.setAttribute("font-size", "32");
    marker.textContent = "üéÅ";
    giftMarkersLayer.appendChild(marker);
  });
}
 
/* ---------- BUTTON LOGIC ---------- */
function completeTask() {
  points = addPoints(20);
  updateUI();
}
 
function exchangeSteps() {
  if (points < costPerStep) {
    alert("Not enough points!");
    return;
  }
 
  points = addPoints(-costPerStep);
  currentStep++;
 
  if (giftSteps.includes(currentStep)) {
    showReward(currentStep);
  }
 
  if (currentStep === 100) {
    puzzleCount++;
    if (puzzleCount <= 4) {
      document.getElementById("pz" + puzzleCount).classList.add("done");
    }
    currentStep = 0;
    updateUI();
    updateCarPosition(true);
 
    window.location.href = "lucky_draw.html";
    return;
  }
 
  updateUI();
  updateCarPosition(true);
}
 
/* ---------- LOGO MODAL (ONLY ONE) ---------- */
(function initLogoModal() {
  const logoBtn = document.getElementById("logoBtn");
  const logoModal = document.getElementById("logoModal");
  const closeLogo = document.getElementById("closeLogo");
 
  logoBtn.addEventListener("click", () => (logoModal.style.display = "flex"));
  closeLogo.addEventListener("click", () => (logoModal.style.display = "none"));
  logoModal.addEventListener("click", (e) => {
    if (e.target === logoModal) logoModal.style.display = "none";
  });
})();
 
/* ---------- INIT ---------- */
btnCompleteTask.addEventListener("click", completeTask);
btnExchange.addEventListener("click", exchangeSteps);
btnRewardOk.addEventListener("click", closeReward);
 
updateUI();
updateCarPosition(false);
placeGiftMarkers();
requestAnimationFrame(updateParticles);
</script>
 
</body>
</html>